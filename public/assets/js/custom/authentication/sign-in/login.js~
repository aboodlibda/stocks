"use strict";

$(document).ready(function () {
    const form = $('#kt_sign_in_form');
    const submitButton = $('#kt_sign_in_submit');

    form.on('submit', function (e) {
        e.preventDefault();

        // Clear previous errors
        $('.error-message').text('');

        // Show loading indication
        submitButton.attr('data-kt-indicator', 'on');
        submitButton.prop('disabled', true);

        let formData = new FormData(this);
        let token = $('meta[name="csrf-token"]').attr('content');
        formData.append('_token', token);

        $.ajax({
            url: form.attr('action'),
            type: 'GET',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                if (response.success) {
                    Swal.fire({
                        text: response.message,
                        icon: "success",
                        buttonsStyling: false,
                        confirmButtonText: "Ok, got it!",
                        customClass: {
                            confirmButton: "btn btn-primary"
                        }
                    }).then(function (result) {
                        if (result.isConfirmed) {
                            window.location.href = form.data('kt-redirect-url');
                        }
                    });
                } else {
                     Swal.fire({
                        text: response.message,
                        icon: "error",
                        buttonsStyling: false,
                        confirmButtonText: "Ok, got it!",
                        customClass: {
                            confirmButton: "btn btn-primary"
                        }
                    });
                }
            },
            error: function (xhr) {
                let errors = xhr.responseJSON.errors;
                if (errors) {
                    if (errors.email) {
                        $('#email-error').text(errors.email[0]);
                    }
                    if (errors.password) {
                        $('#password-error').text(errors.password[0]);
                    }
                } else if(xhr.responseJSON.message) {
                     Swal.fire({
                        text: xhr.responseJSON.message,
                        icon: "error",
                        buttonsStyling: false,
                        confirmButtonText: "Ok, got it!",
                        customClass: {
                            confirmButton: "btn btn-primary"
                        }
                    });
                }
            },
            complete: function () {
                // Hide loading indication
                submitButton.removeAttr('data-kt-indicator');
                submitButton.prop('disabled', false);
            }
        });
    });
});
